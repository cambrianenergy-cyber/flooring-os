rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(workspaceId) {
      return isSignedIn() && workspaceId == request.auth.uid;
    }
    function isMember(workspaceId) {
      return isSignedIn() && (
        // Check if workspace ID matches user ID (owner)
        workspaceId == request.auth.uid ||
        // Check if members subcollection exists
        exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid))
      );
    }
    function isAdmin(workspaceId) {
      return isSignedIn() && (
        // Owner is always admin
        workspaceId == request.auth.uid ||
        // Check admin role in subcollection
        (exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)).data.role in ["founder", "owner", "admin"])
      );
    }
    function isFounder(workspaceId) {
      return isSignedIn() && (
        // Owner is founder
        workspaceId == request.auth.uid ||
        // Check founder role in subcollection
        (exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)).data.role == "founder")
      );
    }
    function isInvitee() {
      return request.auth != null && resource.data.email == request.auth.token.email;
    }
    function sameWorkspace() {
      return request.resource.data.workspaceId == resource.data.workspaceId;
    }

    // --- Users or userProfiles ---
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    // --- Workspaces ---
    match /workspaces/{workspaceId} {
      allow read: if isMember(workspaceId);
      allow create: if isSignedIn();
      allow update, delete: if isAdmin(workspaceId);

      // --- Members subcollection ---
      match /members/{memberId} {
        allow read: if isMember(workspaceId);
        allow create, update, delete: if isAdmin(workspaceId);
      }

      // --- Invites subcollection ---
      match /invites/{inviteId} {
        allow create, update, delete: if isAdmin(workspaceId);
        allow read: if isAdmin(workspaceId) || isInvitee();
      }
      // --- Invite Acceptance Endpoint ---
      match /accept/{acceptId} {
        allow create: if isInvitee();
        allow read, update, delete: if false;
      }

      // --- Roles subcollection (optional) ---
      match /roles/{roleId} {
        allow read: if isMember(workspaceId);
        allow create, update, delete: if isAdmin(workspaceId);
      }

      // --- Audit Logs (founder-only read) ---
      match /audit_logs/{logId} {
        allow read: if isFounder(workspaceId);
        allow create, update, delete: if false; // server-only
      }

      // --- Policies (founder-only write) ---
      match /policies/{policyId} {
        allow read: if isMember(workspaceId);
        allow create, update, delete: if isFounder(workspaceId);
        allow update: if isFounder(workspaceId) && request.resource.data.keys().hasAny(["lockdownMode"]);
      }

      // --- Integrations (founder-only config changes) ---
      match /integrations/{provider} {
        allow read: if isMember(workspaceId);
        allow update: if isFounder(workspaceId);
        allow create, delete: if false; // server-only
      }

      // --- Onboarding state (TEMP: open for debugging) ---
      match /onboarding/state {
        allow read, write: if true;
      }

      // --- WorkflowStates (TEMP: open for debugging) ---
      match /workflowStates/{docId} {
        allow read, write: if isSignedIn();
      }
      match /workflowStates {
        allow list: if isSignedIn();
      }
    }

    // --- Workspace Members (top-level, if used) ---
    match /workspace_members/{docId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // --- Customers ---
    match /customers/{customerId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
      allow delete: if isSignedIn() && isAdmin(resource.data.workspaceId);
    }

    // --- Invites (top-level, if used) ---
    match /invites/{inviteId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
        // --- Founder Snapshots (development access) ---
        match /founder/{S5mlWvEGqBhK7J1nMSE07wwIlJl1}/globalSnapshots/{docId} {
          allow read: if isSignedIn();
        }
        match /founder/{S5mlWvEGqBhK7J1nMSE07wwIlJl1}/workspaceSnapshots/{docId} {
          allow read: if isSignedIn();
        }
      allow delete: if isSignedIn() && isAdmin(resource.data.workspaceId);
    }

    // --- LEADS PIPELINE ---
    match /leads/{id} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create: if isSignedIn() && isMember(request.resource.data.workspaceId);
      allow update, delete: if isSignedIn() && isAdmin(resource.data.workspaceId) && sameWorkspace();
    }

    // --- Activities ---
    match /activities/{id} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create: if isSignedIn() && isMember(request.resource.data.workspaceId);
      allow update, delete: if isSignedIn() && isAdmin(resource.data.workspaceId) && sameWorkspace();
    }

    // --- Jobs ---
    match /jobs/{jobId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);

      // --- Change Orders ---
      match /change_orders/{coId} {
        allow read: if isSignedIn() && isMember(resource.data.workspaceId);
        allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
      }

      // --- Schedule ---
      match /schedule/{eventId} {
        allow read: if isSignedIn() && isMember(resource.data.workspaceId);
        allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
      }
    }

    // --- Estimates ---
    match /estimates/{estimateId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }

    // --- Invoices ---
    match /invoices/{invoiceId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }

    // --- Reviews ---
    match /reviews/{reviewId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }

    // --- Catalog ---
    match /catalog/materials/{materialId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }
    match /catalog/labor_rates/{rateId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }
    match /catalog/line_item_templates/{templateId} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }

    // --- Billing: Invoices & Payments ---
    match /billing/invoices/{invoiceId} {
      allow read: if isSignedIn() && isAdmin(resource.data.workspaceId);
      allow create, update: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
      allow delete: if false;
    }
    match /billing/payments/{paymentId} {
      allow read: if isSignedIn() && isAdmin(resource.data.workspaceId);
      allow create, update, delete: if false; // server-only (Stripe webhooks)
    }
    match /billing/usage/{id} {
      allow read: if isSignedIn() && isAdmin(resource.data.workspaceId);
      allow create, update, delete: if false; // server-only
    }

    // --- Estimating ---
    match /items/{id} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create: if isSignedIn() && isMember(request.resource.data.workspaceId);
      allow update, delete: if isSignedIn() && isAdmin(resource.data.workspaceId) && sameWorkspace();
    }
    match /versions/{id} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create: if isSignedIn() && isMember(request.resource.data.workspaceId);
      allow update, delete: if isSignedIn() && isAdmin(resource.data.workspaceId) && sameWorkspace();
    }
    match /attachments/{id} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create: if isSignedIn() && isMember(request.resource.data.workspaceId);
      allow update, delete: if isSignedIn() && isAdmin(resource.data.workspaceId) && sameWorkspace();
    }

    // --- Job Execution ---
    match /schedule/{id} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create: if isSignedIn() && isMember(request.resource.data.workspaceId);
      allow update, delete: if isSignedIn() && isAdmin(resource.data.workspaceId) && sameWorkspace();
    }
    match /change_orders/{id} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }
    match /photos/{id} {
      allow read: if isSignedIn() && isMember(resource.data.workspaceId);
      allow create: if isSignedIn() && isMember(request.resource.data.workspaceId);
      allow update, delete: if isSignedIn() && isAdmin(resource.data.workspaceId) && sameWorkspace();
    }

    // --- Workflow Packs / Automation ---
    match /workflows/{id} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }
    match /automations/{id} {
      allow read: if isSignedIn() && isAdmin(resource.data.workspaceId);
      allow create, update, delete: if isSignedIn() && isAdmin(request.resource.data.workspaceId);
    }

    // --- System reliability + governance (founder/admin only) ---
    match /activityLog/{docId} {
      allow read, create: if isAdmin(resource.data.workspaceId);
    }
    match /notifications/{docId} {
      allow read, create: if isAdmin(resource.data.workspaceId);
    }
    match /integrations/{docId} {
      allow read, create: if isAdmin(resource.data.workspaceId);
    }
    match /webhooks/{docId} {
      allow read, create: if isAdmin(resource.data.workspaceId);
    }

    // --- Billing + entitlements (founder/admin only) ---
    match /billingCustomers/{docId} {
      allow read, create: if isAdmin(resource.data.workspaceId);
    }
    match /subscriptions/{docId} {
      allow read, create: if isAdmin(resource.data.workspaceId);
    }
    match /entitlements/{docId} {
      allow read, create: if isAdmin(resource.data.workspaceId);
    }
    match /usage/{docId} {
      allow read, create: if isAdmin(resource.data.workspaceId);
    }
  }
}